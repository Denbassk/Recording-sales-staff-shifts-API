# ИНСТРУКЦИЯ ПО ОБНОВЛЕНИЮ СИСТЕМЫ АВТОРИЗАЦИИ

## ⚠️ ВАЖНО! Прочитайте перед деплоем

Это обновление добавляет систему авторизации и ролей для защиты критических API endpoints.

## Что изменилось:

### 1. **Добавлена система ролей:**
- `admin` - полный доступ ко всем функциям
- `accountant` - доступ к расчету зарплат
- `seller` - только отметка на смену (по умолчанию)

### 2. **Защищены API endpoints:**
- `/calculate-payroll` - только admin и accountant
- `/upload-revenue-file` - только admin и accountant  
- `/payroll/adjustments` - только admin и accountant

### 3. **Добавлена система сессий:**
- Токены авторизации действуют 8 часов
- Автоматическая проверка прав доступа

## Пошаговая инструкция по обновлению:

### ШАГ 1: Обновление базы данных

1. Откройте Supabase Dashboard
2. Перейдите в SQL Editor
3. Скопируйте содержимое файла `migration_add_auth.sql`
4. Выполните скрипт

### ШАГ 2: Назначение ролей

В SQL Editor выполните:

```sql
-- Назначьте себе роль админа (замените на ваше имя)
UPDATE employees SET role = 'admin' WHERE fullname = 'Ваше Имя';

-- Назначьте роль бухгалтеру (если есть)
UPDATE employees SET role = 'accountant' WHERE fullname = 'Имя Бухгалтера';

-- Проверьте результат
SELECT id, fullname, role FROM employees ORDER BY role, fullname;
```

### ШАГ 3: Деплой на GitHub и Fly.io

```bash
# Добавляем изменения
git add .

# Коммитим
git commit -m "Add authorization system with roles"

# Пушим в репозиторий
git push origin main

# Fly.io задеплоит автоматически через GitHub Actions
```

### ШАГ 4: Тестирование

1. **Проверьте логин как продавец:**
   - Должны успешно входить
   - НЕ должны видеть ссылку на страницу зарплат

2. **Проверьте логин как admin/accountant:**
   - Должны успешно входить
   - ДОЛЖНЫ видеть ссылку на страницу зарплат
   - Страница зарплат должна открываться

3. **Проверьте защиту API:**
   - Откройте DevTools → Network
   - Убедитесь, что запросы содержат заголовок Authorization

## Что делать если что-то пошло не так:

### Проблема: "Нет прав доступа к странице"
**Решение:** Проверьте, что правильно назначили роль в базе данных

### Проблема: "Токен недействителен"  
**Решение:** Перелогиньтесь (токены живут 8 часов)

### Проблема: API возвращает 401 или 403
**Решение:** 
1. Проверьте, что токен передается в заголовках
2. Проверьте роль пользователя в БД
3. Убедитесь, что сессия не истекла

## Откат изменений (если нужно):

Если нужно временно отключить защиту:

1. В `server.cjs` закомментируйте `checkAuth` и `checkRole` в эндпоинтах:
```javascript
// Было:
app.post('/calculate-payroll', checkAuth, checkRole(['admin', 'accountant']), async (req, res) => {

// Стало:
app.post('/calculate-payroll', /*checkAuth, checkRole(['admin', 'accountant']),*/ async (req, res) => {
```

2. Задеплойте изменения

## Контрольный чек-лист перед деплоем:

- [ ] Выполнен SQL скрипт миграции
- [ ] Назначена роль admin хотя бы одному пользователю
- [ ] Протестирован логин с разными ролями локально
- [ ] Проверена работа страницы расчета зарплат
- [ ] Сделан бэкап базы данных

## Поддержка:

Если возникли проблемы:
1. Проверьте логи в Fly.io: `fly logs`
2. Проверьте логи в Supabase Dashboard
3. Убедитесь, что таблица `sessions` создана корректно

---

**После успешного деплоя система будет защищена от несанкционированного доступа!**
