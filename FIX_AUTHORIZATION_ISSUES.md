# üîß –ò–ù–°–¢–†–£–ö–¶–ò–Ø –ü–û –ò–°–ü–†–ê–í–õ–ï–ù–ò–Æ –ü–†–û–ë–õ–ï–ú –° –ê–í–¢–û–†–ò–ó–ê–¶–ò–ï–ô

## –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:

1. **Race Condition** - –∫–æ–≥–¥–∞ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–æ–¥–∞–≤—Ü–æ–≤ –≤—Ö–æ–¥—è—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ, —Å–∏—Å—Ç–µ–º–∞ –Ω–µ —É—Å–ø–µ–≤–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∑–∞–ø—Ä–æ—Å—ã
2. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ retry –ª–æ–≥–∏–∫–∏** - –ø—Ä–∏ –≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–±–æ—è—Ö —Å–≤—è–∑–∏ —Å–∏—Å—Ç–µ–º–∞ —Å—Ä–∞–∑—É —Å–¥–∞–µ—Ç—Å—è
3. **–ù–µ—Ç –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Å–º–µ–Ω** - –¥–≤–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–∞ –º–æ–≥—É—Ç —Å–æ–∑–¥–∞—Ç—å –¥—É–±–ª–∏–∫–∞—Ç—ã
4. **–û—Ñ–ª–∞–π–Ω —Ä–µ–∂–∏–º –Ω–µ –º–æ–∂–µ—Ç –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –±–µ–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞**

## –†–µ—à–µ–Ω–∏–µ –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–Ω —Å–µ—Ä–≤–µ—Ä–∞:

### –®–∞–≥ 1: –û–±–Ω–æ–≤–∏—Ç–µ —Å–µ—Ä–≤–µ—Ä–Ω—ã–π –∫–æ–¥

–ó–∞–º–µ–Ω–∏—Ç–µ —Ñ—É–Ω–∫—Ü–∏—é –ª–æ–≥–∏–Ω–∞ –≤ `server.cjs` –Ω–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—É—é –≤–µ—Ä—Å–∏—é –∏–∑ —Ñ–∞–π–ª–∞ `server_login_fix.js`.

–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ `withLock` –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race conditions
- –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏
- –î–æ–±–∞–≤–ª–µ–Ω–∞ retry –ª–æ–≥–∏–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–º–µ–Ω
- –ë–æ–ª–µ–µ —Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–º–µ–Ω

### –®–∞–≥ 2: –û–±–Ω–æ–≤–∏—Ç–µ –∫–ª–∏–µ–Ω—Ç—Å–∫–∏–π –∫–æ–¥

–ó–∞–º–µ–Ω–∏—Ç–µ `script.js` –Ω–∞ `script_improved.js`.

–ö–ª—é—á–µ–≤—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è:
- –î–æ–±–∞–≤–ª–µ–Ω–∞ retry –ª–æ–≥–∏–∫–∞ (3 –ø–æ–ø—ã—Ç–∫–∏)
- –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –¥–≤–æ–π–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–æ–∫
- –£–ª—É—á—à–µ–Ω–Ω–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –æ—Ñ–ª–∞–π–Ω –¥–∞–Ω–Ω—ã—Ö
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è

### –®–∞–≥ 3: –î–µ–ø–ª–æ–π –Ω–∞ Fly.io

```bash
# –í –ø–∞–ø–∫–µ –ø—Ä–æ–µ–∫—Ç–∞
cd D:\Shifts-api\Shifts-api

# –ö–æ–º–º–∏—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π
git add .
git commit -m "Fix: Race condition and retry logic for login"

# –î–µ–ø–ª–æ–π –Ω–∞ Fly.io
fly deploy
```

## –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ –ë–ï–ó –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–µ—Ä–≤–µ—Ä–∞:

### –í–∞—Ä–∏–∞–Ω—Ç 1: –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è

–°–æ–∑–¥–∞–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—é –¥–ª—è –º–∞–≥–∞–∑–∏–Ω–æ–≤:
1. –ü–µ—Ä–≤—ã–π –ø—Ä–æ–¥–∞–≤–µ—Ü –≤—Ö–æ–¥–∏—Ç –∏ –∂–¥–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
2. –í—Ç–æ—Ä–æ–π –ø—Ä–æ–¥–∞–≤–µ—Ü –∂–¥–µ—Ç 30 —Å–µ–∫—É–Ω–¥
3. –ó–∞—Ç–µ–º –≤—Ö–æ–¥–∏—Ç –≤—Ç–æ—Ä–æ–π –ø—Ä–æ–¥–∞–≤–µ—Ü

### –í–∞—Ä–∏–∞–Ω—Ç 2: –õ–æ–∫–∞–ª—å–Ω—ã–π –ø—Ä–æ–∫—Å–∏-—Å–µ—Ä–≤–µ—Ä

–ó–∞–ø—É—Å—Ç–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π Node.js —Å–µ—Ä–≤–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –∫—ç—à–∏—Ä–æ–≤–∞—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–ø—Ä–æ—Å–∞–º–∏:

```javascript
// local-proxy.js
const express = require('express');
const axios = require('axios');
const app = express();

const queue = [];
let processing = false;

app.use(express.json());

app.post('/login', async (req, res) => {
    // –î–æ–±–∞–≤–ª—è–µ–º –≤ –æ—á–µ—Ä–µ–¥—å
    return new Promise((resolve) => {
        queue.push({ req: req.body, res, resolve });
        processQueue();
    });
});

async function processQueue() {
    if (processing || queue.length === 0) return;
    
    processing = true;
    const item = queue.shift();
    
    try {
        // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
        await new Promise(r => setTimeout(r, 1000));
        const response = await axios.post('https://shifts-api.fly.dev/login', item.req);
        item.res.json(response.data);
    } catch (error) {
        item.res.status(error.response?.status || 500).json(error.response?.data || { error: 'Server error' });
    }
    
    processing = false;
    item.resolve();
    
    // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Å–ª–µ–¥—É—é—â–∏–π
    setTimeout(processQueue, 500);
}

app.listen(3001, () => {
    console.log('–ü—Ä–æ–∫—Å–∏ –∑–∞–ø—É—â–µ–Ω –Ω–∞ –ø–æ—Ä—Ç—É 3001');
});
```

## –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–º–µ–Ω:

### –°–∫—Ä–∏–ø—Ç –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–º–µ–Ω –∏–∑ —Ñ–∞–π–ª–∞:

```javascript
// bulk-shifts-upload.js
const { createClient } = require('@supabase/supabase-js');
const fs = require('fs');
const path = require('path');

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
const supabaseUrl = 'https://pdiminbulbzlywvnowta.supabase.co';
const supabaseKey = 'YOUR_SERVICE_ROLE_KEY'; // –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ service role key

const supabase = createClient(supabaseUrl, supabaseKey);

async function uploadShifts(csvFile) {
    // –ß–∏—Ç–∞–µ–º CSV —Ñ–∞–π–ª —Å –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã–º–∏ —Å–º–µ–Ω–∞–º–∏
    // –§–æ—Ä–º–∞—Ç: employee_name,date,store_address
    const data = fs.readFileSync(csvFile, 'utf8');
    const lines = data.split('\n').slice(1); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
    
    let successCount = 0;
    let errorCount = 0;
    
    for (const line of lines) {
        if (!line.trim()) continue;
        
        const [employeeName, date, storeAddress] = line.split(',').map(s => s.trim());
        
        try {
            // –ù–∞—Ö–æ–¥–∏–º —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
            const { data: employee } = await supabase
                .from('employees')
                .select('id')
                .ilike('fullname', employeeName)
                .single();
            
            if (!employee) {
                console.error(`–°–æ—Ç—Ä—É–¥–Ω–∏–∫ –Ω–µ –Ω–∞–π–¥–µ–Ω: ${employeeName}`);
                errorCount++;
                continue;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –º–∞–≥–∞–∑–∏–Ω
            let storeId = null;
            if (storeAddress && storeAddress !== '–°—Ç–∞—Ä—à–∏–π –ø—Ä–æ–¥–∞–≤–µ—Ü') {
                const { data: store } = await supabase
                    .from('stores')
                    .select('id')
                    .eq('address', storeAddress)
                    .single();
                
                if (store) storeId = store.id;
            }
            
            // –°–æ–∑–¥–∞–µ–º —Å–º–µ–Ω—É
            const { error } = await supabase
                .from('shifts')
                .insert({
                    employee_id: employee.id,
                    store_id: storeId,
                    shift_date: date,
                    started_at: new Date(`${date}T09:00:00`).toISOString()
                });
            
            if (error) {
                if (error.code === '23505') {
                    console.log(`–°–º–µ–Ω–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç: ${employeeName} - ${date}`);
                } else {
                    console.error(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–º–µ–Ω—ã: ${error.message}`);
                    errorCount++;
                }
            } else {
                console.log(`‚úì –°–º–µ–Ω–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞: ${employeeName} - ${date}`);
                successCount++;
            }
            
        } catch (err) {
            console.error(`–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏: ${err.message}`);
            errorCount++;
        }
        
        // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –∑–∞–ø—Ä–æ—Å–∞–º–∏
        await new Promise(r => setTimeout(r, 200));
    }
    
    console.log(`\n–ò—Ç–æ–≥–æ: —É—Å–ø–µ—à–Ω–æ ${successCount}, –æ—à–∏–±–æ–∫ ${errorCount}`);
}

// –ó–∞–ø—É—Å–∫
uploadShifts('missed_shifts.csv');
```

### –§–æ—Ä–º–∞—Ç CSV —Ñ–∞–π–ª–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏:
```csv
employee_name,date,store_address
–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω,2025-08-29,–ú–∞–≥–∞–∑–∏–Ω ‚Ññ1
–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä,2025-08-29,–ú–∞–≥–∞–∑–∏–Ω ‚Ññ2
–°–∏–¥–æ—Ä–æ–≤ –°–∏–¥–æ—Ä,2025-08-30,–°—Ç–∞—Ä—à–∏–π –ø—Ä–æ–¥–∞–≤–µ—Ü
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞:

### SQL –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–±–ª–µ–º:

```sql
-- –ù–∞–π—Ç–∏ –¥—É–±–ª–∏–∫–∞—Ç—ã —Å–º–µ–Ω
SELECT employee_id, shift_date, COUNT(*) as count
FROM shifts
GROUP BY employee_id, shift_date
HAVING COUNT(*) > 1;

-- –ù–∞–π—Ç–∏ —Å–º–µ–Ω—ã –±–µ–∑ –º–∞–≥–∞–∑–∏–Ω–∞
SELECT s.*, e.fullname
FROM shifts s
JOIN employees e ON s.employee_id = e.id
WHERE s.store_id IS NULL
AND NOT e.id LIKE 'SProd%'
ORDER BY s.shift_date DESC;

-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –¥–Ω—è–º
SELECT 
    shift_date,
    COUNT(*) as total_shifts,
    COUNT(DISTINCT store_id) as stores_count,
    COUNT(CASE WHEN store_id IS NULL THEN 1 END) as no_store_count
FROM shifts
WHERE shift_date >= '2025-08-01'
GROUP BY shift_date
ORDER BY shift_date DESC;
```

## –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—é –ø—Ä–æ–±–ª–µ–º:

### 1. –û—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏–æ–Ω–Ω—ã–µ –º–µ—Ä—ã:
- –ù–∞–∑–Ω–∞—á—å—Ç–µ –æ—Ç–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤ –∫–∞–∂–¥–æ–º –º–∞–≥–∞–∑–∏–Ω–µ
- –í–≤–µ–¥–∏—Ç–µ –≥—Ä–∞—Ñ–∏–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–ø–µ—Ä–≤–∞—è —Å–º–µ–Ω–∞ –≤ 8:00, –≤—Ç–æ—Ä–∞—è –≤ 8:30)
- –°–æ–∑–¥–∞–π—Ç–µ —á–µ–∫-–ª–∏—Å—Ç –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–∞–≥–∞–∑–∏–Ω–∞

### 2. –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —É–ª—É—á—à–µ–Ω–∏—è:
- –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à–∏—Ä—É—é—â–∏–π –ø—Ä–æ–∫—Å–∏
- –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é
- –í–Ω–µ–¥—Ä–∏—Ç–µ SMS/Email —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–π —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏

### 3. –†–µ–∑–µ—Ä–≤–Ω—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã:
- Google Forms –¥–ª—è –∑–∞–ø–∏—Å–∏ —Å–º–µ–Ω
- Telegram –±–æ—Ç –¥–ª—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
- Excel —Ñ–∞–π–ª —Å –º–∞–∫—Ä–æ—Å–æ–º –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏

## –ö–æ–Ω—Ç–∞–∫—Ç—ã –¥–ª—è –ø–æ–º–æ—â–∏:

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ó–∞–ø—É—Å—Ç–∏—Ç–µ `START_APP_DEBUG.bat`
2. –°–æ—Ö—Ä–∞–Ω–∏—Ç–µ —Å–∫—Ä–∏–Ω—à–æ—Ç –æ—à–∏–±–∫–∏
3. –ó–∞–ø–∏—à–∏—Ç–µ –≤—Ä–µ–º—è –∏ –∏–º—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞
4. –û—Ç–ø—Ä–∞–≤—å—Ç–µ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É

---

**–í–∞–∂–Ω–æ:** –ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π—Ç–µ —Å–∏—Å—Ç–µ–º—É –≤ —Ç–µ—Å—Ç–æ–≤–æ–º –æ–∫—Ä—É–∂–µ–Ω–∏–∏ –ø–µ—Ä–µ–¥ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ–º –≤ –ø—Ä–æ–¥–∞–∫—à–Ω!